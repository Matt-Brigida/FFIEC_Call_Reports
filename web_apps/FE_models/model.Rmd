---
title: "Model"
output: html_document
runtime: shiny
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(plm)
library(ggplot2)
library(ggthemes)

panelOrig <- readRDS(url("https://github.com/Matt-Brigida/FFIEC_Call_Reports/blob/master/querying_data_and_analysis/analyses/panel_data_analysis/full_panel/panel.rds?raw=true"))

inputPanel(
    sliderInput("t1", "Capital Ratio", max=1, min=0, value = c(.05, .2), step = 0.01),
    selectizeInput("model", "Small Business Loan Size", choices = c("Less $100,000" = 1,
                                                                  "$100,000 to $250,000" = 2,
                                                                  "$250,000 to $1,000,000" = 3)),
    actionButton("do", "Run Model")
)

work <- eventReactive(input$do, {
            panel <- panelOrig[panelOrig$t1_LR_pre_2014_lagged_1_year > input$t1[1] & panelOrig$t1_LR_pre_2014_lagged_1_year < input$t1[2], ]

    if(input$model == 1){
        FEmodel1 <- plm(amt_CI_less_100_SB_loans_Delt ~  t1_LR_pre_2014_lagged_1_year + less_100_lagged_SB_loans_TA + ROA + NPA_TA + I(log(panel$total_assets_lagged_1_year)), data = panel, model = "within", effect = "twoways")
        result <- summary(FEmodel1)

    } else {
        if(input$model == 2){
            FEmodel2 <- plm(amt_CI_100_250_SB_loans_Delt ~  t1_LR_pre_2014_lagged_1_year + X100_250_lagged_SB_loans_TA + ROA + NPA_TA + I(log(panel$total_assets_lagged_1_year)), data = panel, model = "within", effect = "twoways")
            result <- summary(FEmodel2) 
        } else {
            FEmodel3 <- plm(amt_CI_250_1000_SB_loans_Delt ~  t1_LR_pre_2014_lagged_1_year + X250_1000_lagged_SB_loans_TA + ROA + NPA_TA + I(log(panel$total_assets_lagged_1_year)), data = panel, model = "within", effect = "twoways")
            result <- summary(FEmodel3)

        }
    }

    adjRsq <- result$r.squared[2]
    Rsq <- result$r.squared[1]
    slope <- as.numeric(result$coefficients[rownames(result$coefficients) == "t1_LR_pre_2014_lagged_1_year",][1])
    pVal <- as.numeric(result$coefficients[rownames(result$coefficients) == "t1_LR_pre_2014_lagged_1_year",][4])
    
    if(input$model == 1){
    plot_y_upper_limit <- as.numeric(quantile(panel$amt_CI_less_100_SB_loans_Delt, .85, na.rm = TRUE))
    plot_y_lower_limit <- as.numeric(quantile(panel$amt_CI_less_100_SB_loans_Delt, .15, na.rm = TRUE))
    intercept <- mean(panel$amt_CI_less_100_SB_loans_Delt, na.rm = TRUE) - slope * mean(panel$t1_LR_pre_2014_lagged_1_year, na.rm = TRUE)

    ggplot(panel, aes(x = t1_LR_pre_2014_lagged_1_year, amt_CI_less_100_SB_loans_Delt)) + geom_hex() + ylim(plot_y_lower_limit, plot_y_upper_limit) + labs(title = paste0("Capital Ratio Coef: ", round(slope, 2), "| P-value: ", round(pVal, 2)), subtitle = paste0("R-sq: ", round(Rsq, 4), "| Adj-R-sq: ", round(adjRsq, 4)), x = "T1 Leverage Ratio", y = "Change in SB Loans (Less than $100,000)") + theme_solarized(light = FALSE) + scale_colour_solarized("red") + geom_abline(slope = slope, intercept = intercept)

    } else {
        if(input$model == 2){
            plot_y_upper_limit <- as.numeric(quantile(panel$amt_CI_100_250_SB_loans_Delt, .85, na.rm = TRUE))
            plot_y_lower_limit <- as.numeric(quantile(panel$amt_CI_100_250_SB_loans_Delt, .15, na.rm = TRUE))
            intercept <- mean(panel$amt_CI_100_250_SB_loans_Delt, na.rm = TRUE) - slope * mean(panel$t1_LR_pre_2014_lagged_1_year, na.rm = TRUE)

            ggplot(panel, aes(x = t1_LR_pre_2014_lagged_1_year, amt_CI_100_250_SB_loans_Delt)) + geom_hex() + ylim(plot_y_lower_limit, plot_y_upper_limit) + labs(title = paste0("Capital Ratio Coef: ", round(slope, 2), "| P-value: ", round(pVal, 2)), subtitle = paste0("R-sq: ", round(Rsq, 4), "| Adj-R-sq: ", round(adjRsq, 4)), x = "T1 Leverage Ratio", y = "Change in SB Loans ($100,000 to $250,000)") + theme_solarized(light = FALSE) + scale_colour_solarized("red") + geom_abline(slope = slope, intercept = intercept)

            } else {
                plot_y_upper_limit <- as.numeric(quantile(panel$amt_CI_250_1000_SB_loans_Delt, .85, na.rm = TRUE))
                plot_y_lower_limit <- as.numeric(quantile(panel$amt_CI_250_1000_SB_loans_Delt, .15, na.rm = TRUE))
                intercept <- mean(panel$amt_CI_250_1000_SB_loans_Delt, na.rm = TRUE) - slope * mean(panel$t1_LR_pre_2014_lagged_1_year, na.rm = TRUE)

                ggplot(panel, aes(x = t1_LR_pre_2014_lagged_1_year, amt_CI_250_1000_SB_loans_Delt)) + geom_hex() + ylim(plot_y_lower_limit, plot_y_upper_limit) + labs(title = paste0("Capital Ratio Coef: ", round(slope, 2), "| P-value: ", round(pVal, 2)), subtitle = paste0("R-sq: ", round(Rsq, 4), "| Adj-R-sq: ", round(adjRsq, 4)), x = "T1 Leverage Ratio", y = "Change in SB Loans ($250,000 to $1 million)") + theme_solarized(light = FALSE) + scale_colour_solarized("red") + geom_abline(slope = slope, intercept = intercept)

            }
        }
      })

    renderPlot({
work()
})

```
